# Polymorphic Malware Detection Framework: Behaviour-First Analytic and Kill-Chain Mapping
Ala Dabat  
Senior SOC / Incident Response / Threat Intelligence Analyst  

---

## 1. Introduction

This document presents a behavioural detection framework for polymorphic malware, loader families, and supply-chain style DLL/driver sideloading using Microsoft Defender for Endpoint (MDE) telemetry. The purpose is to detect threats that mutate their hashes, filenames, offsets, and internal code structure. The approach focuses on invariant behaviours: how the malware is staged, introduced, executed, and anchored inside a compromised environment.

This framework includes:
- A structured analysis of polymorphic loader behaviour  
- MITRE ATT&CK mapping  
- Behavioural and IOC matrices  
- A kill-chain alignment table  
- Simulated polymorphic test data  
- A unified Hybrid Detection Rule suitable for production use  
- Noise, signal, and tuning guidance  

All content is designed for use in Microsoft Defender for Endpoint Advanced Hunting or Sentinel with the MDE connector enabled.

---

## 2. Behavioural Characteristics of Polymorphic Malware

Polymorphic malware mutates surface indicators while preserving core logic. It avoids static detection by altering binary content each run. However, behavioural surfaces remain highly consistent across variants.

### 2.1 Constantly Changing (Not Detection-Reliable)
- File hashes  
- Filenames  
- Binary offsets and sections  
- Embedded strings  
- Packing stubs  
- Encoded payload blobs  

### 2.2 Behavioural Invariants (Detection-Reliable)
| Behaviour Pattern | Description |
|-------------------|-------------|
| Staging in writable folders | Dropping DLL/SYS/EXE into ProgramData, Temp, AppData, or user-writable locations |
| Unsigned load events | Loading unsigned or invalidly-signed DLLs or SYS drivers |
| LOLBin execution chains | rundll32, regsvr32, mshta, powershell used as loaders |
| Fast drop-to-load cycles | DLL loaded minutes after drop (0–5 minutes) |
| Dormancy periods | Backdoor DLLs dropped and never loaded for days |
| Registry execution references | Run keys and AppInit pointing to executables, DLLs, or LOLBins |
| Remote component retrieval | DLL/SYS/EXE downloaded from external URLs |
| Rapid outbound connections | C2 within 0–60 seconds of process creation |
| Disappearing payloads | Dropped file deleted within minutes after execution |

These patterns reliably identify polymorphic activity even when hashes and payloads vary.

---

## 3. MITRE ATT&CK Mapping for Polymorphic Loader Behaviours

| MITRE Technique | Description | Behaviour in Framework |
|-----------------|-------------|------------------------|
| T1574.002 | DLL Sideloading | Unsigned DLL loaded by high-value applications |
| T1574.001 | Hijack Execution Flow | Loading unexpected DLLs via LOLBins |
| T1547.001 | Registry Run Keys | Registry entries referencing executables or DLL loaders |
| T1543.003 | Driver Load Abuse | Unsigned SYS files staged in writable folders |
| T1105 | Ingress Tool Transfer | DLL/SYS/EXE downloaded from remote URLs |
| T1059 | Command-Line Execution | Encoded and obfuscated PowerShell/WSH |
| T1071 | C2 Channel | Fast outbound connections following process creation |
| T1564 | Defense Evasion | Disappearing payloads and filesystem cleanup |
| T1027 | Obfuscated/Encoded Files | Base64 encoded commands in PowerShell and WScript |
| T1195 | Supply Chain Compromise | High-value processes loading unsigned DLLs |

---

## 4. Full Behaviour Matrix for Polymorphic Detection

| Behaviour Category | Detection Requirement | Covered by Hybrid Rule |
|--------------------|------------------------|-------------------------|
| Writable path staging | DLL/SYS/EXE dropped under ProgramData/Temp/AppData | ✓ |
| Unsigned loads | DLL/SYS loaded with invalid or unknown signatures | ✓ |
| Fast drop-to-load | DLL loaded within 5 minutes of drop | ✓ |
| Dormancy | DLL/SYS present for >3–7 days and never loaded | ✓ |
| LOLBin-based loader | rundll32/regsvr32/mshta/powershell as loader | ✓ |
| High-value process loader | Outlook, Teams, svchost, winlogon | ✓ |
| Registry-based execution | Registry values referencing executables or DLLs | ✓ |
| Remote retrieval | DLL/SYS/EXE downloaded from external URL | ✓ |
| Fast C2 | Network connection within 60 seconds of process start | ✓ |
| Disappearing payload | Dropped file deleted within short window | ✓ |
| Encoded command chains | Base64, encoded PowerShell parameters | ✓ |
| Sandbox detection strings | Command line referencing VM/sandbox artefacts | ✓ |
| Sleep/delay evasion | timeout, sleep loops used before execution | ✓ |

---

## 5. Kill Chain Coverage

| Kill Chain Stage | Behaviour Detected | Coverage |
|------------------|--------------------|----------|
| Initial Access | Drop to writable folder, suspicious parent process | High |
| Execution | Fast DLL load, LOLBin loader, encoded commands | High |
| Persistence | Registry run keys referencing executables | High |
| Privilege Escalation | Driver staging, unsigned SYS loads | Medium |
| Defense Evasion | Dormant files, disappearing payloads | High |
| Credential Access | Not primary focus | Partial |
| Discovery | Limited to LOLBin enumeration if present | Low |
| Lateral Movement | Not primary focus | Partial |
| Command & Control | Fast C2, suspicious ports, new outbound infra | High |
| Exfiltration | Out of scope | None |

---

## 6. IOC and Behaviour Mapping Table

| IOC Type | Example | Behavioural Flag |
|----------|---------|------------------|
| Writable path drop | C:\ProgramData\Vendor\app.dll | DroppedInWritable |
| Unsigned DLL | SignatureStatus = Unsigned | UnsignedOrSuspicious |
| Fast drop-to-load | DLL loaded <5 min after drop | FastDropToLoad |
| Dormant DLL | Present >7 days without load | DormantDLL |
| Dormant driver | SYS never loaded | DormantDriver |
| Encoded command | powershell -enc | IsEncodedCommand |
| LOLBin loader | rundll32.exe app.dll | LoaderIsLOLBIN |
| Remote download | url ends with .dll/.exe/.sys | DownloadCloseToDrop |
| Rapid C2 | Connection <60 seconds | FastC2 |
| File deletion | Deleted immediately after use | DisappearingPayload |

---

## 7. Simulated Polymorphic Test Dataset

| Scenario | Description | Expected Flags | Expected Severity |
|----------|-------------|----------------|-------------------|
| Test A: Office → LOLBin → DLL | Word spawns rundll32 which loads newly dropped DLL | DroppedInWritable, FastDropToLoad, LoaderIsLOLBIN | Medium/High |
| Test B: Browser → drop → delete | Chrome downloads EXE, executed and deleted | DroppedInWritable, FastDelete | Medium |
| Test C: BYOVD driver staging | SYS dropped under ProgramData, never loaded | DormantDriver | Medium |
| Test D: Encoded PS loader | powershell -enc writes DLL then C2 | IsEncodedCommand, FastC2 | High |
| Test E: Supply-chain sideload | Outlook loads unsigned DLL in app folder | LoaderIsHighValue, UnsignedOrSuspicious | High |

---

## 8. Noise vs Signal Guidance

| Noise Source | Mitigation |
|--------------|-------------|
| Software updaters dropping DLLs | Add path or process exclusions |
| SCCM and RMM agents | Suppress based on signer or parent process name |
| Temporary .dll/.exe from installers | Extend LoadDelay or require additional signals |
| Legitimate browser downloads | Require LOLBin involvement or encoded commands |
| Admin tools using PowerShell | Require fast C2 and writable-path staging |

---

## 9. Hybrid Detection Rule (Complete Version)

```kql
// Polymorphic_Malware_Killchain_Hunt_v1
// Behavioural hunt for polymorphic loaders, DLL/driver staging, LOLBins, fast C2, disappearing payloads, and basic sandbox evasion.
// Author: Ala Dabat

let lookback             = 7d;
let dormant_window       = 3d;
let confidence_threshold = 5;

// Writable / suspicious locations
let suspicious_folders = dynamic([
  @"C:\ProgramData\",
  @"C:\Users\",
  @"C:\Temp\",
  @"C:\Windows\Temp\",
  @"C:\Windows\Tasks\"
]);

// Core LOLBins often abused as loaders / droppers / C2 stagers
let lolbins = dynamic([
  "rundll32.exe","regsvr32.exe","mshta.exe","powershell.exe",
  "wscript.exe","cscript.exe","cmd.exe","bitsadmin.exe",
  "certutil.exe","wmic.exe","msiexec.exe","installutil.exe"
]);

// High-value processes where unsigned DLL loads are more worrying
let high_value_processes = dynamic([
  "3CXDesktopApp.exe","SolarWinds.BusinessLayerHost.exe","OUTLOOK.EXE",
  "Teams.exe","svchost.exe","services.exe","winlogon.exe","lsass.exe","explorer.exe"
]);

// Office / mail / browser families used for initial access
let office_mail = dynamic(["winword.exe","excel.exe","powerpnt.exe","outlook.exe","hxmail.exe"]);
let browsers    = dynamic(["chrome.exe","msedge.exe","iexplore.exe","firefox.exe"]);

// Simple sandbox / VM / analysis indicators in command lines
let sandbox_strings = dynamic(["vbox","virtualbox","vmware","qemu","sandboxie","wireshark","procmon","ollydbg","x64dbg","idag"]);

// Registry value data patterns referencing executables
let registry_exec_keywords = dynamic([
  ".dll",".exe",".ps1",".bat",".vbs",".cmd",".js",
  "rundll32.exe","mshta.exe","powershell.exe","cmd.exe"
]);

// Process creation surface (LOLBINs, encoded cmd, sandbox checks)
let proc_surface =
DeviceProcessEvents
| where Timestamp >= ago(lookback)
| where ActionType == "ProcessCreated"
| extend ProcTime = Timestamp
| extend IsLOLBIN = iif(FileName in~ (lolbins), 1, 0)
| extend ParentIsOfficeMail = iif(InitiatingProcessFileName in~ (office_mail), 1, 0)
| extend ParentIsBrowser = iif(InitiatingProcessFileName in~ (browsers), 1, 0)
| extend IsEncodedCommand =
    iif(ProcessCommandLine has_any (" -enc"," -e ","EncodedCommand","frombase64string","iex ","invoke-expression")
      or ProcessCommandLine matches regex @"[A-Za-z0-9\+/]{50,}={0,2}", 1, 0)
| extend SandboxCheck = iif(tolower(ProcessCommandLine) has_any (sandbox_strings), 1, 0)
| extend DelayBehaviour = iif(ProcessCommandLine has_any ("Start-Sleep","timeout /T","ping 127.0.0.1 -n","choice /T "), 1, 0)
| project DeviceId,DeviceName,ProcTime,ProcessId,FileName,FolderPath,ProcessCommandLine,
          InitiatingProcessFileName,InitiatingProcessCommandLine,
          IsLOLBIN,ParentIsOfficeMail,ParentIsBrowser,IsEncodedCommand,SandboxCheck,DelayBehaviour;

// File drops and file deletes
let file_events =
DeviceFileEvents
| where Timestamp >= ago(lookback)
| extend FileExt = tolower(split(FileName, ".", -1)[-1])
| extend InWritablePath = iif(FolderPath has_any (suspicious_folders), 1, 0)
| where FileExt in ("dll","sys","exe")
| project DeviceId,DeviceName,FileEventTime=Timestamp,FileActionType=ActionType,
          FileName,FolderPath,FileExt,SHA256,InitiatingProcessFileName,
          InitiatingProcessCommandLine,InitiatingProcessId,InWritablePath;

let file_drops =
file_events
| where FileActionType in ("FileCreated","FileModified","FileRenamed")
| project DeviceId,DeviceName,DropTime=FileEventTime,DroppedFileName=FileName,DroppedFolderPath=FolderPath,
          DroppedFileExt=FileExt,DroppedSHA256=SHA256,DroppingProcessName=InitiatingProcessFileName,
          DroppingProcessCommandLine=InitiatingProcessCommandLine,DroppingProcessId=InitiatingProcessId,
          DroppedInWritable=InWritablePath;

let file_deletes =
file_events
| where FileActionType == "FileDeleted"
| project DeviceId,DeviceName,DeleteTime=FileEventTime,DeletedFileName=FileName,
          DeletedFolderPath=FolderPath,DeletedFileExt=FileExt,DeletedSHA256=SHA256,
          DeletingProcessName=InitiatingProcessFileName,DeletingProcessCommandLine=InitiatingProcessCommandLine,
          DeletingProcessId=InitiatingProcessId;

// Unsigned / suspicious image loads
let image_loads =
DeviceImageLoadEvents
| where Timestamp >= ago(lookback)
| extend LoadedFileExt = tolower(split(FileName, ".", -1)[-1])
| where LoadedFileExt in ("dll","sys")
| extend UnsignedOrSuspicious = SignatureStatus in ("Unsigned","Invalid","Unknown") or isempty(Signer)
| where UnsignedOrSuspicious
| project DeviceId,DeviceName,LoadTime=Timestamp,LoaderProcessName=InitiatingProcessFileName,
          LoaderProcessCommandLine=InitiatingProcessCommandLine,LoaderProcessId=InitiatingProcessId,
          LoadedFileName=FileName,LoadedFolderPath=FolderPath,LoadedFileExt,LoadedSHA256=SHA256,
          Signer,SignatureStatus;

// Network events: fast C2 and downloads
let network =
DeviceNetworkEvents
| where Timestamp >= ago(lookback)
| where ActionType == "ConnectionSuccess"
| project DeviceId,DeviceName,ConnectionTime=Timestamp,ProcessId,
          RemoteUrl,RemoteIP,RemotePort,InitiatingProcessFileName,
          InitiatingProcessCommandLine;

let net_downloads =
network
| where isnotempty(RemoteUrl)
| where RemoteUrl has_any (".dll",".exe",".sys",".bin",".dat");

// Registry persistence
let reg_persistence =
DeviceRegistryEvents
| where Timestamp >= ago(lookback)
| where ActionType in ("RegistryValueSet","RegistryValueAdded")
| where RegistryValueData has_any (registry_exec_keywords)
| project DeviceId,DeviceName,RegTime=Timestamp,RegistryKey,
          RegistryValueData,RegistryProcessName=InitiatingProcessFileName,
          RegistryProcessCommandLine=InitiatingProcessCommandLine;

// Join surfaces
file_drops
| join kind=leftouter image_loads on DeviceId,DeviceName,$left.DroppedFileName==$right.LoadedFileName
| join kind=leftouter file_deletes on DeviceId,DeviceName,DroppedFileName==DeletedFileName
| join kind=leftouter proc_surface on DeviceId,DroppingProcessId==ProcessId
| join kind=leftouter network on DeviceId,ProcessId
| join kind=leftouter reg_persistence on DeviceId,DeviceName

// Derived timings
| extend LoadDelayMinutes = iff(isnotempty(LoadTime), toint((LoadTime-DropTime)/1m), int(null))
| extend DeleteDelayMinutes = iff(isnotempty(DeleteTime), toint((DeleteTime-DropTime)/1m), int(null))
| extend C2DelaySeconds = iff(isnotempty(ConnectionTime), toint((ConnectionTime-ProcTime)/1s), int(null))

// Flags
| extend FastDropToLoad = iif(isnotempty(LoadTime) and LoadDelayMinutes between (0..5),1,0)
| extend DormantDLL = iif(DroppedFileExt=="dll" and isnull(LoadTime) and DropTime <= now()-dormant_window,1,0)
| extend DormantDriver = iif(DroppedFileExt=="sys" and isnull(LoadTime) and DropTime <= now()-dormant_window,1,0)
| extend DisappearingPayload = iif(DroppedInWritable==1 and isnotempty(LoadTime) and isnotempty(DeleteTime) and DeleteDelayMinutes between (0..30),1,0)
| extend FastC2 = iif(isnotempty(C2DelaySeconds) and C2DelaySeconds between (0..60),1,0)
| extend SuspiciousPort = iif(RemotePort !in (80,443,53,3389,25,587,993,995) and RemotePort!=0,1,0)
| extend LoaderIsHighValue = iif(LoaderProcessName in~ (high_value_processes),1,0)
| extend LoaderIsLOLBIN = iif(LoaderProcessName in~ (lolbins),1,0)
| extend DropperIsLOLBIN = iif(DroppingProcessName in~ (lolbins),1,0)
| extend ParentOfficeMail = iif(ParentIsOfficeMail==1,1,0)
| extend ParentBrowser = iif(ParentIsBrowser==1,1,0)
| extend DownloadCloseToDrop = iif(isnotempty(RemoteUrl) and DroppedInWritable==1 and abs(toint((DropTime-ConnectionTime)/1m)) between (0..10),1,0)

// Confidence score
| extend ConfidenceScore =
      iif(DroppedInWritable==1,2,0)
    + iif(FastDropToLoad==1,3,0)
    + iif(DormantDriver==1,3,0)
    + iif(DormantDLL==1,2,0)
    + iif(DisappearingPayload==1,3,0)
    + iif(FastC2==1,3,0)
    + iif(SuspiciousPort==1,1,0)
    + iif(LoaderIsHighValue==1,2,0)
    + iif(LoaderIsLOLBIN==1,2,0)
    + iif(DropperIsLOLBIN==1,2,0)
    + iif(ParentOfficeMail==1,2,0)
    + iif(ParentBrowser==1,1,0)
    + iif(DownloadCloseToDrop==1,2,0)
    + iif(IsEncodedCommand==1,2,0)
    + iif(SandboxCheck==1,1,0)
    + iif(DelayBehaviour==1,1,0)

// Severity
| extend Severity =
  case(
    ConfidenceScore >= 13, "High",
    ConfidenceScore between (9..12), "Medium",
    ConfidenceScore between (confidence_threshold..8), "Low",
    "Informational"
  )

// Kill chain mapping
| extend KillChainStage =
  case(
    FastC2==1 or SuspiciousPort==1, "CommandAndControl",
    FastDropToLoad==1 or IsEncodedCommand==1, "Execution",
    isnotempty(RegistryKey), "Persistence",
    DormantDriver==1 or DormantDLL==1 or DisappearingPayload==1, "DefenseEvasion",
    DownloadCloseToDrop==1, "Delivery",
    "Discovery"
  )

// MITRE mapping
| extend MitreTechniques = dynamic(["T1027","T1059","T1574.002","T1547","T1543","T1055","T1071","T1564","T1105","T1197","T1140","T1587"])

// Reasoning
| extend Reason =
  case(
    DisappearingPayload == 1 and FastC2 == 1,
      "Staged DLL/EXE loaded, beaconed externally, then removed from disk.",
    FastDropToLoad == 1 and LoaderIsLOLBIN == 1 and ParentOfficeMail == 1,
      "Office application spawned LOLBin which loaded unsigned DLL shortly after drop.",
    DormantDriver == 1 and DownloadCloseToDrop == 1,
      "Unsigned SYS driver downloaded and staged without load events.",
    DormantDLL == 1 and LoaderIsHighValue == 1,
      "Unsigned DLL staged under app directory associated with high-value process.",
    FastC2 == 1 and IsEncodedCommand == 1,
      "Encoded command executed and contacted remote endpoint shortly after start.",
    isnotempty(RegistryKey) and RegistryValueData has_any (registry_exec_keywords),
      "Registry persistence referencing executables or DLL loaders.",
    DroppedInWritable == 1 and DownloadCloseToDrop == 1,
      "Executable downloaded to writable folder on host.",
    SandboxCheck == 1,
      "Command line contains indicators of sandbox or analysis tool detection.",
    true,
      "Suspicious behavioural chain involving DLL/SYS staging and loader activity."
  )

// Hunter guidance
| extend HunterDirectives =
  case(
    Severity == "High" and KillChainStage in ("Execution","CommandAndControl"),
      "Treat as active compromise. Isolate host if possible, block RemoteIP/RemoteUrl, collect process tree and memory.",
    Severity == "High" and KillChainStage == "Persistence",
      "Investigate persistence mechanism. Audit registry keys and associated binaries.",
    Severity == "Medium" and (DormantDriver == 1 or DormantDLL == 1),
      "Investigate dormant artifacts. Confirm legitimacy with asset owner.",
    Severity == "Medium" and FastC2 == 1,
      "Review network activity and reputation of remote endpoint.",
    Severity == "Low",
      "Review in context of other events. Adjust filters for known legitimate tools.",
    true,
      "Use as hunting signal. Correlate with additional alerts on host."
  )

| where ConfidenceScore >= confidence_threshold

| project Timestamp  = coalesce(LoadTime,DropTime,ConnectionTime,RegTime),
          DeviceName,Severity,ConfidenceScore,KillChainStage,Reason,HunterDirectives,MitreTechniques,
          DropTime,LoadTime,DeleteTime,ConnectionTime,RegTime,
          DroppedFileName,DroppedFolderPath,DroppedFileExt,DroppedSHA256,
          LoadedFileName,LoadedFolderPath,LoadedFileExt,LoadedSHA256,
          DroppingProcessName,DroppingProcessCommandLine,
          LoaderProcessName,LoaderProcessCommandLine,
          ProcessFileName=FileName,ProcessCommandLine,
          RemoteUrl,RemoteIP,RemotePort,FastC2,SuspiciousPort,
          DroppedInWritable,FastDropToLoad,DormantDLL,DormantDriver,
          DisappearingPayload,DownloadCloseToDrop,IsEncodedCommand,
          SandboxCheck,DelayBehaviour,LoaderIsHighValue,LoaderIsLOLBIN,
          DropperIsLOLBIN,ParentOfficeMail,ParentBrowser
| order by Timestamp desc
