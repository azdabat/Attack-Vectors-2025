# Polymorphic Malware — Complete Threat Hunter Pack (2025)
Threat Intel + SOC L3 + Red-Team Hybrid Reference  
Author: Ala Dabat (Alstrum)

---

# 1. Overview

Polymorphic malware (2023–2025) represents a class of modern loaders and post-compromise implants that mutate on each execution:

- **Per-victim binary mutations**
- **Memory-only loaders**
- **Token theft and identity abuse**
- **Cloud-native pivot**
- **Polymorphic C2 fingerprints**
- **Anti-analysis and anti-sandbox behaviour**

This pack includes:
- Threat Hunter Playbook (complete)
- MITRE ATT&CK heat-map for polymorphic activity
- Advanced behavioural KQL rulepack (MDE/Sentinel)
- Pivot guides for Endpoint → Identity → Cloud correlation

---

# 2. MITRE ATT&CK Coverage (Polymorphic Malware 2025)

```
MITRE CATEGORY                 DETECTION COVERAGE
──────────────────────────────────────────────────────────────
TA0001 Initial Access          ●○○  (Often bypassed by polymorphism)
TA0002 Execution               ●●○  (Behavioural detection possible)
TA0003 Persistence             ●●○  (Polymorphic registry/task rotation)
TA0004 Privilege Escalation    ●●●  (Drivers, token manipulation)
TA0005 Defense Evasion         ●○○  (Strong attacker advantage)
TA0006 Credential Access       ●●●  (Memory scraping / token theft)
TA0007 Discovery               ●●○  (Internal recon patterns)
TA0008 Lateral Movement        ●●●  (Strong detection via LM geometry)
TA0009 Collection              ●●○  (Staging anomalies)
TA0010 Exfiltration            ●●○  (Network/cloud telemetry key)
TA0011 Command & Control       ●●○  (JA3/DGA anomalies)
```

Legend:  
●●● Strong defender visibility  
●●○ Medium visibility (pivot required)  
●○○ Weak visibility (attacker advantage)

---

# 3. Threat Hunter Workflow (2025)

### STEP 1 — Start at **execution geometry**
- User-facing parent → suspicious child
- Rare binaries (high entropy)
- Multiple similar-but-unique executables

### STEP 2 — Memory behaviour
- Unbacked regions  
- RWX transitions  
- Remote thread creation  

### STEP 3 — Identity pivot
- Token theft  
- Impossible travel  
- OAuth anomalies  
- Session replay  

### STEP 4 — Cloud pivot
- Metadata service access  
- Unexpected control-plane operations  

### STEP 5 — C2 anomalies
- Rotating JA3/JA3S  
- DGA queries  
- Low-and-slow periodicity with jitter  

---

# 4. KQL RULEPACK (Behaviour-First Polymorphic Detection)

This rulepack is **safe**, does not detect malware families by IOC, and uses **behavioural patterns only**, making it suitable for polymorphic hunting.

---

## RULE 1 — Suspicious Parent → Child Anomalies (Execution Geometry)

```kql
DeviceProcessEvents
| where Timestamp >= ago(7d)
| where InitiatingProcessFileName in ("winword.exe","excel.exe","outlook.exe",
                                      "chrome.exe","msedge.exe","teams.exe")
| where not(FileName endswith ".tmp")
| where FileName !in ("chrome.exe","msedge.exe","teams.exe")
| extend Prevalence = iff(FileSize < 3mb, "Low", "Normal")
| summarize count(), makeset(FileName), makeset(SHA1) by InitiatingProcessFileName, DeviceId
| where count_ > 3 or Prevalence == "Low"
```

**Hunter Directive:**  
Anchor here when polymorphic loaders arrive via phishing or drive-by.

---

## RULE 2 — Memory Injection Indicators (RWX + Remote Thread)

```kql
DeviceEvents
| where Timestamp >= ago(7d)
| where ActionType in ("CreateRemoteThread", "MemoryWrite", "MemoryProtect", 
                       "SuspiciousMemoryModification")
| project Timestamp, DeviceId, InitiatingProcessFileName, 
         ReportId, AccountName, ActionType
```

**Hunter Directive:**  
Polymorphic loaders eventually inject into a trusted process. This table catches that transition.

---

## RULE 3 — Token Theft Indicators (Identity Pivot)

```kql
SigninLogs
| where ResultType == 0
| extend Location = strcat(Country, ",", City)
| summarize FirstSeen=min(TimeGenerated), LastSeen=max(TimeGenerated), 
            Locations = make_set(Location), IPs = make_set(IPAddress)
            by UserPrincipalName
| where array_length(Locations) > 1 or array_length(IPs) > 3
```

**Hunter Directive:**  
Token theft (especially browser-stealing) leaves identity anomalies long after the polymorphic loader vanishes.

---

## RULE 4 — Metadata Cloud Pivot (Container/VM Compromise)

```kql
DeviceNetworkEvents
| where Timestamp >= ago(14d)
| where RemoteIP in ("169.254.169.254","169.254.170.2")  // AWS/Azure metadata
| summarize count(), makeset(InitiatingProcessFileName) by DeviceId
| where count_ > 2
```

**Hunter Directive:**  
Modern polymorphic implants pivot to cloud metadata very early.

---

## RULE 5 — JA3/JA3S Anomalies (Polymorphic C2)

```kql
DeviceNetworkEvents
| where Timestamp >= ago(7d)
| where InitiatingProcessFileName !in ("chrome.exe","msedge.exe")
| extend TLSFingerprint = tostring(AdditionalFields.JA3)
| summarize count(), dcount(RemoteIP), makeset(RemoteIP) by DeviceId, TLSFingerprint
| where dcount_RemoteIP > 10 or count_ > 100
```

**Hunter Directive:**  
Polymorphic C2 rotates JA3 fingerprints regularly. Track TLS anomalies per host.

---

## RULE 6 — Suspicious Temp/AppData Execution (Common for Polymorphic Loaders)

```kql
DeviceProcessEvents
| where Timestamp >= ago(7d)
| where FolderPath has_any ("\\AppData\\Local\\Temp", "\\AppData\\Roaming", "\\Temp")
| where FileName !in ("msiexec.exe","update.exe","teams.exe")
| summarize count(), makeset(CommandLine) by DeviceId, FileName
| where count_ > 3
```

**Hunter Directive:**  
Polymorphic loaders commonly stage disguised payloads in user directories.

---

## RULE 7 — Lateral Movement Burst Pattern (Mid-Chain Detection)

```kql
DeviceNetworkEvents
| where Timestamp >= ago(7d)
| where RemotePort in (445,135,5985,5986,3389)
| summarize count(), dcount(RemoteIP) by DeviceId
| where dcount_RemoteIP > 5
```

**Hunter Directive:**  
Polymorphic loaders rarely stay local—LM bursts reveal the infection.

---

## RULE 8 — Ransomware Staging (End-Stage Polymorphic Campaigns)

```kql
DeviceFileEvents
| where Timestamp >= ago(2d)
| where FileName endswith ".tmp"
| where ActionType == "FileCreated"
| summarize count() by DeviceId
| where count_ > 2000
```

**Hunter Directive:**  
If the polymorphic chain leads to ransomware, mass file creation is the first reliable clue.

---

# 5. Threat Hunting Pivot Map (Endpoint → Identity → Cloud)

```
EXECUTION ANOMALY
    │
    ├───► Memory Events (DeviceEvents)
    │
    ├───► Identity Pivot (SigninLogs, AuditLogs)
    │
    ├───► Cloud Activity (AzureActivity, CloudAppEvents)
    │
    └───► C2 Patterns (DeviceNetworkEvents, DNS logs)
```

**Guidance:**  
Never stop at endpoint.  
Polymorphic campaigns ALWAYS touch identity and cloud infrastructure.

---

# 6. Recommended Repository Structure

```
/Polymorphic-Malware-Hunting/
│
├── README.md                (This document)
├── /kql-rulepack/           (All queries in modular files)
├── /diagrams/               (ASCII/graph diagrams)
├── /methodology/            (Threat models, detection logic)
└── /mitre-heatmap/          (SVG + ASCII)
```

---

# 7. Key Takeaway

Polymorphic malware is NOT a file-based threat.  
It is a **behavioural campaign**.  
This rulepack + heatmap + methodology gives threat hunters the full visibility stack they need in 2025.

END OF FILE
